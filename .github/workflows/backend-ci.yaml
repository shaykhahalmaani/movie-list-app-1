name: Backend Continuous Integration

on:
  pull_request:
    branches: [main]
    paths:
      - "services/catalog_api/**"
      - ".github/workflows/backend-ci.yaml"
  workflow_dispatch:

permissions:
  contents: read

env:
  WORKING_DIRECTORY: services/catalog_api

jobs:
  lint:
    name: Lint backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "${{ env.WORKING_DIRECTORY }}/requirements.txt"

      - name: Restore pip cache
        id: pip-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: catalog-api-${{ runner.os }}-${{ hashFiles(format('{0}/requirements.txt', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            catalog-api-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: pip install -r requirements.txt

      - name: Run flake8
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: flake8 catalog_api tests

  test:
    name: Test backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "${{ env.WORKING_DIRECTORY }}/requirements.txt"

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: catalog-api-${{ runner.os }}-${{ hashFiles(format('{0}/requirements.txt', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            catalog-api-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: pip install -r requirements.txt

      - name: Run pytest
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: pytest

  build:
    name: Build container image
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "${{ env.WORKING_DIRECTORY }}/requirements.txt"

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: catalog-api-${{ runner.os }}-${{ hashFiles(format('{0}/requirements.txt', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            catalog-api-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: pip install -r requirements.txt

      - name: Build docker image
        run: |
          docker build -t movie-backend:ci services/catalog_api
